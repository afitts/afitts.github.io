<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

<!-- Extra Header for IPython Notebooks
================================================== -->
  <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:500px;}
    /*
      Add your own MailChimp form style overrides in your site stylesheet or in this style block.
      We recommend moving this block and the preceding CSS link to the HEAD of your HTML file.
     */
  </style>

	<!-- Basic Page Needs
  ================================================== -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="google-site-verification" content="AgIAQN_qsniIQWOq659Bnhzx-LZts2FdgP1kLgtQg-k" />
  <meta name="google-site-verification" content="-wneVy0z_MWocNaXikWZzyTe__HZbZDCRfLYEJ1sAg8" />

  <title>One-Shot Learning on Humpback Whales with Siamese Nerual Networks</title>

  <meta name="description" content="">
  <meta name="author" content="Alex Fitts">
  <meta name="copyright" content="&copy; Copyright Greg Reda, 2013 to Present">

  <!-- Mobile Specific Metas
  ================================================== -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Fonts 
  ================================================== -->
  <link href='http://fonts.googleapis.com/css?family=Open+Sans|Merriweather|Source+Code+Pro' rel='stylesheet' type='text/css'>

  <!-- CSS
  ================================================== -->
  <link rel="stylesheet" href="/theme/css/style.min.css?cfc9322a">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Feeds
  ================================================== -->
  <link rel="alternate" type="application/atom+xml" href="http://afitts.github.io/feeds/all.atom.xml" title="Alex Fitts Full Atom Feed">

	<!-- Facebook Open Graph
  ================================================== -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="One-Shot Learning on Humpback Whales with Siamese Nerual Networks">
  <meta property="og:url" content="http://afitts.github.io/2018/12/03/humpback-siamese/">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Alex Fitts">
  <meta property="og:image" content="http://afitts.github.io/theme/images/avatar.jpg">

  <!-- Twitter Cards
  ================================================== -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@Alex_Fitts">
  <meta name="twitter:creator" content="@Alex_Fitts">
  <meta name="twitter:domain" content="gregreda.com">
  <meta name="twitter:image" content="http://afitts.github.io/theme/images/avatar.jpg">
  <meta name="twitter:title" content="One-Shot Learning on Humpback Whales with Siamese Nerual Networks">
  <meta name="twitter:description" content="">

	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->


	<!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="/theme/images/favicon.ico">
	<link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">

</head>
<body>
	<!-- Primary Page Layout
	================================================== -->
	<div class="container">
<!-- Navigation
================================================== -->
<nav class="navbar">
  <div class="navbar-brand six columns"> <!-- Yes, I know this is a douchey class name -->
      <ul>
        <li>
          <a href="/" title="Home"><img id="logo" src="/theme/images/avatar.jpg"></a>
        </li>
        <li>
          <h1><a href="/" title="Home">Alex Fitts</a></h1>
        </li>
      </ul>
      <ul id="social-icons">
        <li>
          <a class="icon" href="https://twitter.com/Alex_Fitts" title="Twitter">
            <i class="fa fa-fw fa-twitter"></i>
          </a>
          </li>
        <li>
          <a class="icon" href="https://github.com/afitts" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="https://www.linkedin.com/in/alex-fitts-64163b128/" title="LinkedIn">
            <i class="fa fa-fw fa-linkedin"></i>
          </a>
        </li>
      </ul> <!-- End social-icons ul -->
    </div> <!-- End navbar-brand -->

  <div class="navbar-links">
      <ul>
        <li><a href="/pub/">Publications</a></li>
        <li><a href="/talks/">Talks</a></li>
        <li><a href="/blog/">Blog</a></li>
	<li><a href="/pdfs/FittsResume.pdf">Resume</a></li>
        <!--        <li><a href="/coffee/">Coffee?</a></li> -->
      </ul> <!-- End navbar-links ul -->
    </div> <!-- End navbar-links -->
</nav> <!-- End navbar -->		<section id="content" class="twelve columns">

  <!-- Article Headers
  ================================================================== -->
  <h1 class="article-title"><a href="/2018/12/03/humpback-siamese/" title="Permalink to One-Shot Learning on Humpback Whales with Siamese Nerual Networks">One-Shot Learning on Humpback Whales with Siamese Nerual Networks</a></h1>
  <h5 class="article-date">December 03, 2018
  </h5>
  <hr class="small"></hr>

  <!-- Article Content
  ================================================================== -->
  <div class="article-content">
    <p>In this notebook I will explore setting up a <a href="http://www.cs.utoronto.ca/~gkoch/files/msc-thesis.pdf">Siamese Neural Network</a> (SNN), using the fastai/pytorch framework, to try and identify whales by their flukes (tail fins). The dataset comes from the kaggle humpback whale identification <a href="https://www.kaggle.com/c/humpback-whale-identification">challege</a>. The inspiriation for this technique originated from Martin Piotte's <a href="https://www.kaggle.com/martinpiotte/whale-recognition-model-with-score-0-78563">kaggle kernel</a> which implemented a SNN in keras.</p>
<p>I'll be focusing on training an SNN as they are specifically tailored for one-shot learning tasks, which consists of classification under the restriction that we may only observe a single example of each possible class before making a prediction about a test instance. This is extremely useful given that in my previous <a href="http://afitts.github.io/2018/11/04/humpback/">post</a> I found that the majority of whales in the dataset only have 1-4 examples in the training set. </p>
<h2>Imports</h2>
<div class="highlight"><pre><span class="o">%</span><span class="n">reload_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">from</span> <span class="nn">fastai</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.vision</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai.callbacks</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>


<div class="highlight"><pre><span class="kn">import</span> <span class="nn">fastai</span>
<span class="n">fastai</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>


<div class="highlight"><pre>&#39;1.0.39&#39;
</pre></div>


<div class="highlight"><pre><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">&#39;../input&#39;</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s">&#39;train.csv&#39;</span><span class="p">);</span> 
</pre></div>


<div class="highlight"><pre><span class="c">## Filtering classes with at least 60 images for quick experiments</span>
<span class="n">cnter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="s">&#39;cnt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s">&#39;Id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cnter</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<span class="c">#Not consider new_whale images and hence considering 500 as upper cutoff</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[(</span><span class="n">train</span><span class="p">[</span><span class="s">&#39;cnt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">60</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s">&#39;cnt&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">500</span><span class="p">)]</span> 
</pre></div>


<p>Duplicating the entire dataframe so that we can generate a positive pair and a negative pair for each image; maintaing 50% positive pairs and 50% negative pairs for the saimese network. 
Why this is done can be understood in below sections</p>
<div class="highlight"><pre><span class="n">train</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">train1</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">train1</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train1</span><span class="p">)</span>
<span class="n">target_col</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>


<h2>Custom Itembase and ItemList for Siamese Networks</h2>
<ul>
<li>Much of this follows the Custom Item List tutorial(https://docs.fast.ai/tutorial.itemlist.html#Example:-ImageTuple)</li>
<li>Though blindly following the steps in the tutorial might work, i was not very comfortable doing that and hence spent a few hours digging into the library  and understanding how various pieces inside it work</li>
<li>I would suggest starting with tabular data.py as tabular is relatively easier to follow and gives an overall idea of the different pieces involved in getting the databunch ready</li>
<li>At a very high level, creation of databunch for Image application follows this path. <ul>
<li>When factory methods like from_df are called, it instantiates the corresponding ImageItemList. Important things includes creation of items, xtra df with necessary info etc. (vision/data.py - ImageItemList class)</li>
<li>Most imp thing to note here is the get() func responsible for retreving data given the index. This func links the ImageItemList to the Image(Itembase) by returning the retrived item as the class of Itembase. I missed this as it was very subtle in the code and couldnt connect the dots initially.</li>
<li>.split_by_.. - Much of this happens in data_block.py, ItemLists class and easier to follow</li>
<li>Label_from_df - This is where a lot of heavy lifting seems to happen. As ItemLists doesnt have label_from_df attri, it falls back to ItemList class(using '<strong><em>_get</em>_attr</strong>') and does the job. Also, finally the class is changed to LabelLists which gives it the functionality to create databunch etc. Refer to data_block.py and LabelList and LabelLists classes</li>
<li>Also Deduction of target variable class, and assignment of processor, loss_func etc happen here</li>
<li>.databunch does the rest</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">imagenet_stats</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span class="c"># The primary difference from the tutorial is with how normalization is being done here</span>
<span class="k">class</span> <span class="nc">SiamImage</span><span class="p">(</span><span class="n">ItemBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">):</span> <span class="c">## These should of Image type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img2</span> <span class="o">=</span> <span class="n">img1</span><span class="p">,</span> <span class="n">img2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">),</span> <span class="p">[(</span><span class="n">img1</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span><span class="o">/</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span> <span class="p">(</span><span class="n">img2</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span><span class="o">/</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]]</span>
    <span class="k">def</span> <span class="nf">apply_tfms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfms</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img1</span><span class="o">.</span><span class="n">apply_tfms</span><span class="p">(</span><span class="n">tfms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img2</span><span class="o">.</span><span class="n">apply_tfms</span><span class="p">(</span><span class="n">tfms</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">img1</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span><span class="o">/</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img2</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span><span class="o">/</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span><span class="s">&#39;{self.__class__.__name__} {self.img1.shape, self.img2.shape}&#39;</span>
    <span class="k">def</span> <span class="nf">to_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>
</pre></div>


<p>We define get() func such that we get similar pair of images and different pair of images based on idx value. Similar for first half index values and different for next half. Hence the duplicity in dataframe initially.
Currently did things dumbly just to demostrate. Can do generation of pairs, dealing with underbalanced classes and many other things in a much better way </p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">SiamImageItemList</span><span class="p">(</span><span class="n">ImageItemList</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c">#         self._label_cls=FloatList</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span> 

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">match</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="c">#&quot;First set of iteration will generate similar pairs, next will generate different pairs&quot;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">img1</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c"># Returns Image class object</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtra</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">values</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtra</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">values</span>
        <span class="n">wcls</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">simgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">ids</span> <span class="o">==</span> <span class="n">wcls</span><span class="p">]</span>
        <span class="n">dimgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">ids</span> <span class="o">!=</span> <span class="n">wcls</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">simgs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">match</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fn2</span><span class="o">=</span><span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">simgs</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">dimgs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">simgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fn</span><span class="p">:</span>
                    <span class="n">fn2</span> <span class="o">=</span> <span class="p">[</span><span class="n">simgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">match</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">dimgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="n">fn2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">imgs</span><span class="o">==</span><span class="n">fn2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span> <span class="c"># Returns Image class object</span>
        <span class="k">return</span> <span class="n">SiamImage</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">SiamImage</span><span class="p">(</span><span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">],</span> <span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">show_xys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">figsize</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="n">rows</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">axs</span><span class="p">]):</span>
            <span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_one</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span class="n">whl_tfms</span> <span class="o">=</span> <span class="n">get_transforms</span><span class="p">()</span>
<span class="n">bs</span> <span class="o">=</span> <span class="mi">8</span>
</pre></div>


<div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">SiamImageItemList</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="o">/</span><span class="s">&#39;train&#39;</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="o">.</span><span class="n">random_split_by_pct</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">34</span><span class="p">)</span>
         <span class="o">.</span><span class="n">label_from_df</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="n">target_col</span><span class="p">,</span> <span class="n">label_cls</span><span class="o">=</span><span class="n">FloatList</span><span class="p">)</span>
         <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">whl_tfms</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">224</span><span class="p">)</span>
         <span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span class="n">data</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="siamese-with-fast-ai_files/siamese-with-fast-ai_15_0.png"></p>
<div class="highlight"><pre><span class="c"># Checking if the normalization done above is correct</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train_dl</span><span class="p">))</span>
<span class="n">t</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<span class="n">to</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span> <span class="n">std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="n">ti</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToPILImage</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">to</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre>&lt;matplotlib.image.AxesImage at 0x7faa85c81748&gt;
</pre></div>


<p><img alt="png" src="siamese-with-fast-ai_files/siamese-with-fast-ai_16_1.png"></p>
<div class="highlight"><pre><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).





&lt;matplotlib.image.AxesImage at 0x7faa85c649b0&gt;
</pre></div>


<p><img alt="png" src="siamese-with-fast-ai_files/siamese-with-fast-ai_17_2.png"></p>
<h2>Siamese Network</h2>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">fastai.vision</span> <span class="kn">import</span> <span class="n">learner</span>

<span class="k">class</span> <span class="nc">SiameseNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">resnet18</span><span class="p">,</span> <span class="n">lin_ftrs</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="n">emb_sz</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">ps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bn_final</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SiameseNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_sz</span> <span class="o">=</span> <span class="n">arch</span><span class="p">,</span> <span class="n">emb_sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_ftrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn_final</span> <span class="o">=</span> <span class="n">lin_ftrs</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">bn_final</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">create_body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">learner</span><span class="o">.</span><span class="n">cnn_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">)[</span><span class="s">&#39;cut&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">create_head</span><span class="p">(</span><span class="n">num_features_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_sz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_ftrs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bn_final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
        <span class="n">output1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">output2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output1</span><span class="p">,</span> <span class="n">output2</span>

    <span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>


<p><strong>Loss function</strong></p>
<p>After comparing several loss functions and I've found that contrastive loss works the best in the current setup. Distance based logistic loss gives similar performance when model is trained with singe precision, but worse results for training with half precision.</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">ContrastiveLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes embeddings of two samples and a target label == 1 if samples are from the same class and label == 0 otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">5.</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ContrastiveLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">size_average</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">op1</span><span class="p">,</span> <span class="n">op2</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pairwise_distance</span><span class="p">(</span><span class="n">op1</span><span class="p">,</span> <span class="n">op2</span><span class="p">)</span>
        <span class="n">pdist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">*</span><span class="n">target</span>
        <span class="n">ndist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">((</span><span class="n">pdist</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin</span><span class="o">-</span><span class="n">ndist</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="n">size_average</span> <span class="k">else</span> <span class="n">losses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span class="n">model</span> <span class="o">=</span> <span class="n">SiameseNet</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="n">apply_init</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">)</span>
<span class="n">loss_func</span><span class="o">=</span><span class="n">ContrastiveLoss</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="n">siam_learner</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">loss_func</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
</pre></div>


<div class="highlight"><pre><span class="n">siam_learner</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
<span class="n">siam_learner</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre>LR Finder is complete, type {learner_name}.recorder.plot() to see the graph.
</pre></div>


<p><img alt="png" src="siamese-with-fast-ai_files/siamese-with-fast-ai_23_1.png"></p>
<div class="highlight"><pre><span class="n">siam_learner</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">))</span>
</pre></div>


<p>Total time: 01:01 <p><table style='width:300px; margin-bottom:10px'>
  <tr>
    <th>epoch</th>
    <th>train_loss</th>
    <th>valid_loss</th>
  </tr>
  <tr>
    <th>1</th>
    <th>47.814510</th>
    <th>171.353699</th>
  </tr>
  <tr>
    <th>2</th>
    <th>20.523115</th>
    <th>10.899207</th>
  </tr>
  <tr>
    <th>3</th>
    <th>13.116446</th>
    <th>10.829012</th>
  </tr>
  <tr>
    <th>4</th>
    <th>10.895652</th>
    <th>11.075461</th>
  </tr>
  <tr>
    <th>5</th>
    <th>9.889898</th>
    <th>11.046269</th>
  </tr>
</table></p>
  </div>

  <hr class="small"></hr>
  <div class="article-sharing">
      <ul>
      <!-- Twitter Sharing
      ================================================================== -->
      <li><a href="https://twitter.com/share" class="twitter-share-button" data-via="Alex_Fitts">Tweet</a></li>

      <!-- Facebook Sharing
      ================================================================== -->
      <li><div class="fb-share-button"
          data-href="http://afitts.github.io/2018/12/03/humpback-siamese/"
          data-layout="button_count">
      </div></li>
      </ul>
    </div>


    <!-- Back to home
    ================================================================== -->
    <div class="back-to-home">
      <a href="/">← Back to Home</a>
    </div>
    <hr class="small"></hr>
  </div>
  <script>
    // hide ipython notebook cell numbers
  $('div.prompt').hide();
  </script>
		</section>
<!-- Navigation
================================================== -->
<footer class="twelve columns">
	<!-- <hr class="small"> -->
  <p>Generated with <a href="http://getpelican.com">Pelican</a>. Layout done with <a href="http://getskeleton.com">Skeleton</a>. Icons are <a href="http://fortawesome.github.com/Font-Awesome/">Font Awesome</a>. Hosted on <a href="http://aws.amazon.com/s3/">S3</a>.</p>
  <p>&copy; Copyright Alex Fitts, 2016 to present</p>
</footer>	</div><!-- container -->

<!-- Google Analytics
================================================== -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34295039-1']);
  _gaq.push(['_setDomainName', 'gregreda.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  <script type="text/javascript">
    $("a").on('click', function(e) {
      var url = $(this).attr("href");
      console.log(url);
      if (e.currentTarget.host != window.location.host) {
        _gaq.push(['_trackEvent', 'Outbound Links', e.currentTarget.host, url, 0]);
        if (e.metaKey || e.ctrlKey) {
          var newtab = true;
        }
        if (!newtab) {
          e.preventDefault();
          setTimeout('document.location = "' + url + '"', 100);
        }
      }
    });
  </script>
</body> <!-- End body -->

<!-- JavaScript
=================================================== -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<!-- twitter.js
==================================================================== -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>  

<!-- Facebook SDK for JS
==================================================================== -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

</html>